local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

-- Optimized icon library with fallbacks
local Icons = {
    Home = "rbxassetid://7733960981",
    Settings = "rbxassetid://7734053495",
    Check = "rbxassetid://118500495053779",
    Warning = "rbxassetid://123461891178438",
    Dropdown = "rbxassetid://101920802489602",
    Slider = "rbxassetid://125293628617993"
}

-- Cache frequently used values
local UDim2_new = UDim2.new
local Color3_new = Color3.new
local Color3_fromRGB = Color3.fromRGB
local Enum_Font_Gotham = Enum.Font.Gotham
local Enum_Font_GothamBold = Enum.Font.GothamBold

-- Optimized helper functions
local function CreateTween(object, properties, duration, easingStyle, easingDirection)
    local tweenInfo = TweenInfo.new(
        duration or 0.3,
        easingStyle or Enum.EasingStyle.Quart,
        easingDirection or Enum.EasingDirection.Out
    )
    TweenService:Create(object, tweenInfo, properties):Play()
end

local function CreateInstance(className, properties)
    local instance = Instance.new(className)
    for key, value in pairs(properties) do
        if key ~= "Parent" then
            instance[key] = value
        end
    end
    if properties.Parent then
        instance.Parent = properties.Parent
    end
    return instance
end

-- Optimized UI element creators
local UI_Creators = {
    Corner = function(object, radius)
        return CreateInstance("UICorner", {
            CornerRadius = UDim.new(0, radius or 8),
            Parent = object
        })
    end,
    
    Stroke = function(object, color, thickness)
        return CreateInstance("UIStroke", {
            Color = color or Color3_fromRGB(80, 120, 200),
            Thickness = thickness or 1,
            Transparency = 0.5,
            Parent = object
        })
    end,
    
    Gradient = function(object, colors, rotation)
        return CreateInstance("UIGradient", {
            Color = ColorSequence.new(colors),
            Rotation = rotation or 0,
            Parent = object
        })
    end
}

-- Enhanced notification system
local NotificationManager = {
    ActiveNotifications = {},
    NotificationQueue = {}
}

function NotificationManager:Show(title, content, duration, iconType)
    local notificationScreen = CoreGui:FindFirstChild("MirageNotify") or CreateInstance("ScreenGui", {
        Name = "MirageNotify",
        ResetOnSpawn = false,
        Parent = CoreGui
    })

    local notification = CreateInstance("Frame", {
        Size = UDim2_new(0, 300, 0, 70),
        Position = UDim2_new(1, 320, 1, -100),
        BackgroundColor3 = Color3_fromRGB(15, 18, 25),
        Parent = notificationScreen
    })
    
    UI_Creators.Corner(notification, 10)
    local stroke = UI_Creators.Stroke(notification, Color3_fromRGB(100, 150, 255), 1.5)
    
    -- Header
    CreateInstance("TextLabel", {
        Size = UDim2_new(1, -50, 0, 20),
        Position = UDim2_new(0, 45, 0, 10),
        BackgroundTransparency = 1,
        Text = title or "Notification",
        TextColor3 = Color3_fromRGB(240, 245, 255),
        TextSize = 14,
        Font = Enum_Font_GothamBold,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = notification
    })

    -- Content
    CreateInstance("TextLabel", {
        Size = UDim2_new(1, -50, 0, 16),
        Position = UDim2_new(0, 45, 0, 32),
        BackgroundTransparency = 1,
        Text = content or "",
        TextColor3 = Color3_fromRGB(140, 150, 180),
        TextSize = 12,
        Font = Enum_Font_Gotham,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd,
        Parent = notification
    })

    -- Progress bar
    local progressFill = CreateInstance("Frame", {
        Size = UDim2_new(1, 0, 0, 3),
        Position = UDim2_new(0, 0, 1, -3),
        BackgroundColor3 = Color3_fromRGB(100, 150, 255),
        Parent = notification
    })
    UI_Creators.Corner(progressFill, 2)

    -- Animation
    CreateTween(notification, {Position = UDim2_new(1, -320, 1, -100)}, 0.4, Enum.EasingStyle.Back)

    -- Auto-remove after duration
    task.delay(duration or 3, function()
        CreateTween(notification, {
            Position = UDim2_new(1, 320, notification.Position.Y.Scale, notification.Position.Y.Offset)
        }, 0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In)
        
        task.wait(0.4)
        notification:Destroy()
    end)

    return notification
end

-- Optimized window system
local MirageUI = {}

function MirageUI:Window(title)
    local WindowAPI = {}
    local elements = {}
    local currentTab = nil
    local isOpen = false
    
    -- Main screen GUI
    local screenGui = CreateInstance("ScreenGui", {
        Name = "MirageUI",
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        Parent = CoreGui
    })

    -- Toggle button
    local toggleButton = CreateInstance("ImageButton", {
        Size = UDim2_new(0, 45, 0, 45),
        Position = UDim2_new(0, 20, 0.5, -22),
        BackgroundColor3 = Color3_fromRGB(15, 18, 25),
        Parent = screenGui
    })
    UI_Creators.Corner(toggleButton, 10)
    UI_Creators.Stroke(toggleButton, Color3_fromRGB(100, 150, 255), 1.5)

    -- Main window frame
    local mainFrame = CreateInstance("Frame", {
        Size = UDim2_new(0, 580, 0, 420),
        Position = UDim2_new(0.5, -290, 0.5, -210),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = Color3_fromRGB(12, 14, 20),
        Visible = false,
        ClipsDescendants = true,
        Parent = screenGui
    })
    UI_Creators.Corner(mainFrame, 12)
    UI_Creators.Stroke(mainFrame, Color3_fromRGB(80, 120, 200), 1.5)

    -- Header
    local header = CreateInstance("Frame", {
        Size = UDim2_new(1, 0, 0, 50),
        BackgroundColor3 = Color3_fromRGB(8, 10, 15),
        Parent = mainFrame
    })
    UI_Creators.Corner(header, 12)

    -- Title
    CreateInstance("TextLabel", {
        Size = UDim2_new(0, 180, 0, 18),
        Position = UDim2_new(0, 52, 0, 8),
        BackgroundTransparency = 1,
        Text = title or "Mirage UI",
        TextColor3 = Color3_fromRGB(255, 255, 255),
        TextSize = 15,
        Font = Enum_Font_GothamBold,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = header
    })

    -- Tabs container
    local tabsContainer = CreateInstance("Frame", {
        Size = UDim2_new(0, 130, 1, -60),
        Position = UDim2_new(0, 8, 0, 55),
        BackgroundColor3 = Color3_fromRGB(15, 18, 25),
        Parent = mainFrame
    })
    UI_Creators.Corner(tabsContainer, 10)
    CreateInstance("UIListLayout", {
        Padding = UDim.new(0, 5),
        SortOrder = Enum.SortOrder.LayoutOrder,
        Parent = tabsContainer
    })

    -- Content container
    local contentContainer = CreateInstance("ScrollingFrame", {
        Size = UDim2_new(1, -150, 1, -60),
        Position = UDim2_new(0, 145, 0, 55),
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        ScrollBarThickness = 4,
        ScrollBarImageColor3 = Color3_fromRGB(80, 120, 200),
        CanvasSize = UDim2_new(0, 0, 0, 0),
        Parent = mainFrame
    })
    local contentLayout = CreateInstance("UIListLayout", {
        Padding = UDim.new(0, 8),
        SortOrder = Enum.SortOrder.LayoutOrder,
        Parent = contentContainer
    })

    contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        contentContainer.CanvasSize = UDim2_new(0, 0, 0, contentLayout.AbsoluteContentSize.Y + 10)
    end)

    -- Window management
    local function OpenWindow()
        isOpen = true
        mainFrame.Visible = true
        CreateTween(mainFrame, {
            Size = UDim2_new(0, 580, 0, 420),
            Position = UDim2_new(0.5, -290, 0.5, -210)
        }, 0.5, Enum.EasingStyle.Back)
    end

    local function CloseWindow()
        isOpen = false
        CreateTween(mainFrame, {
            Size = UDim2_new(0, 0, 0, 0),
            Position = UDim2_new(0.5, 0, 0.5, 0)
        }, 0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.In)
        task.delay(0.4, function()
            mainFrame.Visible = false
        end)
    end

    toggleButton.MouseButton1Click:Connect(function()
        if isOpen then
            CloseWindow()
        else
            OpenWindow()
        end
    end)

    -- Tab creation
    function WindowAPI:Tab(name)
        local TabAPI = {}
        local tabElements = {}
        
        local tabButton = CreateInstance("TextButton", {
            Size = UDim2_new(1, -10, 0, 36),
            BackgroundColor3 = Color3_fromRGB(20, 24, 32),
            Text = "",
            AutoButtonColor = false,
            Parent = tabsContainer
        })
        UI_Creators.Corner(tabButton, 8)
        UI_Creators.Stroke(tabButton, Color3_fromRGB(40, 50, 70))

        CreateInstance("TextLabel", {
            Size = UDim2_new(1, -20, 1, 0),
            Position = UDim2_new(0, 10, 0, 0),
            BackgroundTransparency = 1,
            Text = name or "Tab",
            TextColor3 = Color3_fromRGB(180, 190, 220),
            TextSize = 11,
            Font = Enum_Font_GothamBold,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = tabButton
        })

        local tabContent = CreateInstance("Frame", {
            Size = UDim2_new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Visible = false,
            Parent = contentContainer
        })
        CreateInstance("UIListLayout", {
            Padding = UDim.new(0, 6),
            SortOrder = Enum.SortOrder.LayoutOrder,
            Parent = tabContent
        })

        if not currentTab then
            currentTab = name
            tabContent.Visible = true
            tabButton.BackgroundColor3 = Color3_fromRGB(80, 120, 200)
        end

        tabButton.MouseButton1Click:Connect(function()
            if currentTab ~= name then
                -- Hide previous tab
                for _, element in pairs(elements) do
                    if element.tab == currentTab then
                        element.frame.Visible = false
                    end
                end
                
                currentTab = name
                tabContent.Visible = true
                
                -- Show elements for this tab
                for _, element in pairs(elements) do
                    if element.tab == name then
                        element.frame.Visible = true
                    end
                end
                
                contentContainer.CanvasPosition = Vector2.new(0, 0)
            end
        end)

        -- Button element
        function TabAPI:Button(text, callback)
            local button = CreateInstance("TextButton", {
                Size = UDim2_new(1, -8, 0, 40),
                BackgroundColor3 = Color3_fromRGB(20, 24, 32),
                Text = "",
                AutoButtonColor = false,
                Parent = tabContent
            })
            UI_Creators.Corner(button, 8)
            UI_Creators.Stroke(button, Color3_fromRGB(50, 60, 80))

            CreateInstance("TextLabel", {
                Size = UDim2_new(1, -20, 1, 0),
                Position = UDim2_new(0, 10, 0, 0),
                BackgroundTransparency = 1,
                Text = text or "Button",
                TextColor3 = Color3_fromRGB(220, 230, 255),
                TextSize = 12,
                Font = Enum_Font_GothamBold,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = button
            })

            button.MouseButton1Click:Connect(function()
                if callback then
                    callback()
                end
                CreateTween(button, {BackgroundColor3 = Color3_fromRGB(100, 150, 255)}, 0.1)
                task.delay(0.1, function()
                    CreateTween(button, {BackgroundColor3 = Color3_fromRGB(20, 24, 32)}, 0.25)
                end)
            end)

            table.insert(elements, {frame = button, tab = name})
            return button
        end

        -- Toggle element
        function TabAPI:Toggle(text, default, callback)
            local isOn = default or false
            
            local toggle = CreateInstance("Frame", {
                Size = UDim2_new(1, -8, 0, 40),
                BackgroundColor3 = Color3_fromRGB(20, 24, 32),
                Parent = tabContent
            })
            UI_Creators.Corner(toggle, 8)
            local stroke = UI_Creators.Stroke(toggle, 
                isOn and Color3_fromRGB(100, 150, 255) or Color3_fromRGB(50, 60, 80)
            )

            CreateInstance("TextLabel", {
                Size = UDim2_new(1, -100, 1, 0),
                Position = UDim2_new(0, 10, 0, 0),
                BackgroundTransparency = 1,
                Text = text or "Toggle",
                TextColor3 = Color3_fromRGB(220, 230, 255),
                TextSize = 12,
                Font = Enum_Font_GothamBold,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = toggle
            })

            local switch = CreateInstance("Frame", {
                Size = UDim2_new(0, 48, 0, 24),
                Position = UDim2_new(1, -60, 0.5, -12),
                BackgroundColor3 = isOn and Color3_fromRGB(80, 120, 200) or Color3_fromRGB(35, 40, 50),
                Parent = toggle
            })
            UI_Creators.Corner(switch, 12)

            local knob = CreateInstance("Frame", {
                Size = UDim2_new(0, 20, 0, 20),
                Position = isOn and UDim2_new(1, -22, 0.5, -10) or UDim2_new(0, 2, 0.5, -10),
                BackgroundColor3 = Color3_fromRGB(255, 255, 255),
                Parent = switch
            })
            UI_Creators.Corner(knob, 10)

            local toggleButton = CreateInstance("TextButton", {
                Size = UDim2_new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = "",
                Parent = toggle
            })

            toggleButton.MouseButton1Click:Connect(function()
                isOn = not isOn
                
                CreateTween(switch, {
                    BackgroundColor3 = isOn and Color3_fromRGB(80, 120, 200) or Color3_fromRGB(35, 40, 50)
                }, 0.25)
                
                CreateTween(knob, {
                    Position = isOn and UDim2_new(1, -22, 0.5, -10) or UDim2_new(0, 2, 0.5, -10)
                }, 0.25, Enum.EasingStyle.Back)
                
                CreateTween(stroke, {
                    Color = isOn and Color3_fromRGB(100, 150, 255) or Color3_fromRGB(50, 60, 80)
                }, 0.2)
                
                if callback then
                    callback(isOn)
                end
            })

            table.insert(elements, {frame = toggle, tab = name})
            
            return {
                Set = function(value)
                    isOn = value
                    switch.BackgroundColor3 = isOn and Color3_fromRGB(80, 120, 200) or Color3_fromRGB(35, 40, 50)
                    knob.Position = isOn and UDim2_new(1, -22, 0.5, -10) or UDim2_new(0, 2, 0.5, -10)
                end,
                Get = function()
                    return isOn
                end
            }
        end

        -- Slider element
        function TabAPI:Slider(text, min, max, default, callback)
            local value = default or min
            
            local slider = CreateInstance("Frame", {
                Size = UDim2_new(1, -8, 0, 45),
                BackgroundColor3 = Color3_fromRGB(15, 18, 25),
                Parent = tabContent
            })
            UI_Creators.Corner(slider, 10)
            UI_Creators.Stroke(slider, Color3_fromRGB(40, 50, 70))

            CreateInstance("TextLabel", {
                Size = UDim2_new(0, 100, 0, 16),
                Position = UDim2_new(0, 10, 0.5, -8),
                BackgroundTransparency = 1,
                Text = text or "Slider",
                TextColor3 = Color3_fromRGB(240, 245, 255),
                TextSize = 12,
                Font = Enum_Font_GothamBold,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = slider
            })

            local sliderBar = CreateInstance("Frame", {
                Size = UDim2_new(0, 120, 0, 5),
                Position = UDim2_new(1, -180, 0.5, -2.5),
                BackgroundColor3 = Color3_fromRGB(25, 30, 40),
                Parent = slider
            })
            UI_Creators.Corner(sliderBar, 2.5)

            local sliderFill = CreateInstance("Frame", {
                Size = UDim2_new((value - min) / (max - min), 0, 1, 0),
                BackgroundColor3 = Color3_fromRGB(100, 150, 255),
                Parent = sliderBar
            })
            UI_Creators.Corner(sliderFill, 2.5)

            local valueLabel = CreateInstance("TextLabel", {
                Size = UDim2_new(0, 45, 0, 16),
                Position = UDim2_new(1, -50, 0.5, -8),
                BackgroundTransparency = 1,
                Text = tostring(value),
                TextColor3 = Color3_fromRGB(100, 150, 255),
                TextSize = 12,
                Font = Enum_Font_GothamBold,
                TextXAlignment = Enum.TextXAlignment.Right,
                Parent = slider
            })

            local isDragging = false

            local function UpdateSlider(input)
                local barX = sliderBar.AbsolutePosition.X
                local barWidth = sliderBar.AbsoluteSize.X
                local percentage = math.clamp((input.Position.X - barX) / barWidth, 0, 1)
                value = math.floor(min + (max - min) * percentage)
                valueLabel.Text = tostring(value)
                
                CreateTween(sliderFill, {Size = UDim2_new(percentage, 0, 1, 0)}, 0.1)
                
                if callback then
                    callback(value)
                end
            end

            local sliderButton = CreateInstance("TextButton", {
                Size = UDim2_new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = "",
                Parent = slider
            })

            sliderButton.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    isDragging = true
                    UpdateSlider(input)
                end
            end)

            UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    isDragging = false
                end
            end)

            UserInputService.InputChanged:Connect(function(input)
                if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                    UpdateSlider(input)
                end
            end)

            table.insert(elements, {frame = slider, tab = name})
            
            return {
                Set = function(newValue)
                    value = newValue
                    valueLabel.Text = tostring(value)
                    local percentage = (value - min) / (max - min)
                    sliderFill.Size = UDim2_new(percentage, 0, 1, 0)
                end,
                Get = function()
                    return value
                end
            }
        end

        -- Dropdown element
        function TabAPI:Dropdown(text, options, default, callback)
            local selected = default or options[1] or ""
            local isExpanded = false
            
            local dropdown = CreateInstance("Frame", {
                Size = UDim2_new(1, -8, 0, 40),
                BackgroundColor3 = Color3_fromRGB(20, 24, 32),
                ClipsDescendants = true,
                Parent = tabContent
            })
            UI_Creators.Corner(dropdown, 8)
            local dropdownStroke = UI_Creators.Stroke(dropdown, Color3_fromRGB(50, 60, 80))

            CreateInstance("TextLabel", {
                Size = UDim2_new(1, -140, 0, 40),
                Position = UDim2_new(0, 10, 0, 0),
                BackgroundTransparency = 1,
                Text = text or "Dropdown",
                TextColor3 = Color3_fromRGB(220, 230, 255),
                TextSize = 12,
                Font = Enum_Font_GothamBold,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = dropdown
            })

            local selectedValue = CreateInstance("TextLabel", {
                Size = UDim2_new(0, 70, 0, 22),
                Position = UDim2_new(1, -80, 0, 9),
                BackgroundColor3 = Color3_fromRGB(30, 35, 45),
                Text = selected,
                TextColor3 = Color3_fromRGB(150, 170, 220),
                TextSize = 10,
                Font = Enum_Font_Gotham,
                Parent = dropdown
            })
            UI_Creators.Corner(selectedValue, 6)

            local optionsContainer = CreateInstance("Frame", {
                Size = UDim2_new(1, -10, 0, 0),
                Position = UDim2_new(0, 5, 0, 44),
                BackgroundTransparency = 1,
                Parent = dropdown
            })
            CreateInstance("UIListLayout", {
                Padding = UDim.new(0, 3),
                SortOrder = Enum.SortOrder.LayoutOrder,
                Parent = optionsContainer
            })

            for _, option in ipairs(options) do
                local optionButton = CreateInstance("TextButton", {
                    Size = UDim2_new(1, 0, 0, 28),
                    BackgroundColor3 = Color3_fromRGB(25, 30, 40),
                    Text = "",
                    AutoButtonColor = false,
                    Parent = optionsContainer
                })
                UI_Creators.Corner(optionButton, 6)

                CreateInstance("TextLabel", {
                    Size = UDim2_new(1, -10, 1, 0),
                    Position = UDim2_new(0, 10, 0, 0),
                    BackgroundTransparency = 1,
                    Text = option,
                    TextColor3 = Color3_fromRGB(180, 190, 220),
                    TextSize = 11,
                    Font = Enum_Font_Gotham,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    Parent = optionButton
                })

                optionButton.MouseButton1Click:Connect(function()
                    selected = option
                    selectedValue.Text = option
                    isExpanded = false
                    CreateTween(dropdown, {Size = UDim2_new(1, -8, 0, 40)}, 0.25)
                    CreateTween(dropdownStroke, {Color = Color3_fromRGB(50, 60, 80)}, 0.2)
                    if callback then
                        callback(selected)
                    end
                end)
            end

            local headerButton = CreateInstance("TextButton", {
                Size = UDim2_new(1, 0, 0, 40),
                BackgroundTransparency = 1,
                Text = "",
                Parent = dropdown
            })

            headerButton.MouseButton1Click:Connect(function()
                isExpanded = not isExpanded
                local targetHeight = isExpanded and (44 + #options * 31) or 40
                CreateTween(dropdown, {Size = UDim2_new(1, -8, 0, targetHeight)}, 0.3)
                CreateTween(dropdownStroke, {
                    Color = isExpanded and Color3_fromRGB(100, 150, 255) or Color3_fromRGB(50, 60, 80)
                }, 0.2)
            end)

            table.insert(elements, {frame = dropdown, tab = name})
            
            return {
                Set = function(value)
                    selected = value
                    selectedValue.Text = value
                end,
                Get = function()
                    return selected
                end
            }
        end

        return TabAPI
    end

    function WindowAPI:Notify(title, content, duration, icon)
        return NotificationManager:Show(title, content, duration, icon)
    end

    function WindowAPI:Destroy()
        screenGui:Destroy()
    end

    return WindowAPI
end

-- Make notification function available globally
MirageUI.Notify = NotificationManager.Show

return MirageUI
